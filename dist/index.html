<!DOCTYPE html>
<html ng-app="demo">

<head>
    <meta charset="utf-8">
    <meta name="description" content="RoomRTC dev tests">
    <title>RoomRTC dev tests</title>
    <!-- load appcss -->
    <link href="bootstrap-v3.3.7.css" rel="stylesheet" type="text/css">
    <link href="style.css" rel="stylesheet" type="text/css">
    <link href="data:image/png;base64,iVBORw0KGgo=" rel="icon" type="image/png">
    <!-- load appjs -->
    <script src="angular-v1.4.9.js"></script>
    <script src="/roomrtc.bundle.js"></script>
    <script type="text/javascript">
        angular.module("demo", [])
            .controller("roomController", function ($scope, $timeout, $sce) {
                $scope.localVideo = null;
                $scope.remoteVideos = [];

                var room = $scope.room = (location.search && location.search.split('?')[1]) || "demo";
                var roomRTC = new RoomRTC({ url: '/' });
                roomRTC.on("connected", function (id) {
                    console.log("connected connectionId: ", id);
                });
                roomRTC.on("readyToCall", function (id) {
                    console.log("readyToCall, connectionId: ", id);
                    roomRTC.initMediaSource()
                        .then(stream => {
                            var streamUrl = roomRTC.getStreamAsUrl(stream);
                            $timeout(function () {
                                $scope.localVideo = $sce.trustAsResourceUrl(streamUrl);
                            });
                            return roomRTC.joinRoom(room);
                        })
                        .then(roomData => {
                            console.log("joinRoom ok: ", roomData);
                            $timeout(function () {
                                $scope.clients = roomData.clients;
                            });
                            return roomData.clients;
                        })
                        .catch(err => {
                            console.error("joinRoom error: ", err);
                        });
                });

                roomRTC.on("videoAdded", function(stream, pc) {
                    console.log("Ohh, we have a new participant", pc.id);
                    $timeout(function() {
                        var streamUrl = roomRTC.getStreamAsUrl(stream);
                        var trustUrl = $sce.trustAsResourceUrl(streamUrl);
                        $scope.remoteVideos.push(trustUrl);
                    })
                });

                /**
                 * Setup control buttons
                 * */
                $scope.stop = function () {
                    roomRTC.stop();
                }

                $scope.start = function () {
                    roomRTC.initMediaSource().then(stream => {
                        var streamUrl = roomRTC.getStreamAsUrl(stream);
                        $timeout(function () {
                            $scope.localVideo = $sce.trustAsResourceUrl(streamUrl);
                        });
                    });
                }
            });
    </script>
</head>

<body ng-controller="roomController">
    <h1>You are in room: <span ng-bind="room">...</span></h1>
    <video class="mirror" id="localVideo" width="300" height="200" ng-src="{{localVideo}}" ng-muted="true" resize autoplay="true" ng-context-menu-disabled="true"></video>
    <div class="media-controls">
        <input type="button" value="Stop" ng-click="stop()">&nbsp;
        <input type="button" value="Start" ng-click="start()">
    </div>
    <div id="remotes">
        <div class="video" ng-repeat="remoteVideo in remoteVideos">
            <video ng-src="{{remoteVideo}}" resize autoplay="true"></video>
        </div>
    </div>
    <p>Display list clients</p>
    <ul>
        <li ng-repeat="(id, client) in clients">{{ $index + 1 }}: [{{ id }},{{ client.name }}]</li>
    </ul>
</body>

</html>